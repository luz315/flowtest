<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ì‘ì„±</title>
    <style>
        .tag { display: inline-block; border: 1px solid black; border-radius: 8px; padding: 5px 10px; margin: 5px; }
        .tag span { margin-left: 8px; color: red; cursor: pointer; }
    </style>
</head>
<body>
<h2>ê³ ì •í™•ì¥ì</h2>
<div id="fixed-container">
    <label><input type="checkbox" value="bat">bat</label>
    <label><input type="checkbox" value="cmd">cmd</label>
    <label><input type="checkbox" value="com">com</label>
    <label><input type="checkbox" value="cpl">cpl</label>
    <label><input type="checkbox" value="exe">exe</label>
    <label><input type="checkbox" value="scr">scr</label>
    <label><input type="checkbox" value="js">js</label>
</div>

<h2>ì»¤ìŠ¤í…€í™•ì¥ì</h2>
<input type="text" id="custom-input" placeholder="í™•ì¥ì ì…ë ¥" maxlength="20"/>
<button onclick="addCustom()">+ì¶”ê°€</button>
<p><span id="count">0</span>/200</p>
<div id="custom-tags"></div>

<br/><br/>
<button onclick="submitPost()">ì €ì¥</button>

<script>
    const MAX_CUSTOM = 200;
    let customList = [];

    window.onload = async function () {
        // ì €ì¥ëœ ê³ ì • í™•ì¥ì ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
        const saved = await fetch('/posts/fixed-extensions').then(r => r.json());
        saved.forEach(val => {
            const input = document.querySelector(`#fixed-container input[value="${val}"]`);
            if (input) input.checked = true;
        });

        // ì €ì¥ëœ ì»¤ìŠ¤í…€ í™•ì¥ì ë¶ˆëŸ¬ì˜¤ê¸°
        const customs = await fetch('/posts/custom-extensions').then(r => r.json());
        customList = customs;
        renderCustomTags();
    }

    function renderCustomTags() {
        const tagContainer = document.getElementById("custom-tags");
        tagContainer.innerHTML = '';
        customList.forEach((ext, index) => {
            const tag = document.createElement("div");
            tag.className = "tag";
            tag.innerHTML = `${ext}<span onclick="removeCustom(${index})">x</span>`;
            tagContainer.appendChild(tag);
        });
        document.getElementById("count").textContent = customList.length;
    }

    async function addCustom() {
        const input = document.getElementById("custom-input");
        const value = input.value.trim().toLowerCase(); // ì¤‘ë³µ ì²´í¬ë¥¼ ìœ„í•´ ì†Œë¬¸ì ê³ ì •
        if (!value) return alert("ì…ë ¥í•˜ì„¸ìš”");
        if (value.length > 20) return alert("20ì ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤");

        // ê³ ì • í™•ì¥ì ì¤‘ë³µ í™•ì¸
        const fixedSelected = [...document.querySelectorAll("#fixed-container input:checked")].map(i => i.value.toLowerCase());
        if (fixedSelected.includes(value)) return alert("ê³ ì • í™•ì¥ìì™€ ì¤‘ë³µë©ë‹ˆë‹¤");

        // ì»¤ìŠ¤í…€ ì¤‘ë³µ í™•ì¸
        if (customList.includes(value)) return alert("ì´ë¯¸ ì¶”ê°€ëœ í™•ì¥ìì…ë‹ˆë‹¤");
        if (customList.length >= MAX_CUSTOM) return alert("200ê°œ ì´ˆê³¼ ë¶ˆê°€");

        // ğŸ‘‰ ì„œë²„ë¡œ ë³´ë‚´ì§€ ì•Šê³  ë¡œì»¬ ìƒíƒœë§Œ ë³€ê²½
        customList.push(value);
        input.value = '';
        renderCustomTags();
    }


    async function removeCustom(index) {
        const value = customList[index];
        try {
            await fetch(`/posts/custom-extensions/${value}`, { method: 'DELETE' });
            customList.splice(index, 1);
            renderCustomTags();
        } catch (e) {
            alert("ì‚­ì œ ì‹¤íŒ¨");
        }
    }

    // ê³ ì • í™•ì¥ì ë³€ê²½ ì‹œ DB ì €ì¥
    document.getElementById("fixed-container").addEventListener("change", async (e) => {
        if (!e.target.value) return;
        const method = e.target.checked ? 'POST' : 'DELETE';
        await fetch(`/posts/fixed-extensions/${e.target.value}`, { method });
    });

    async function submitPost() {
        const fixedTypes = [...document.querySelectorAll("#fixed-container input:checked")].map(i => i.value.toLowerCase());

        // ğŸ”’ ìµœì¢… ì¤‘ë³µ ê²€ì¦ (ê³ ì • + ì»¤ìŠ¤í…€ í•©ì³ì„œ ì¤‘ë³µ ì œê±°)
        const combined = [...fixedTypes, ...customList];
        const unique = new Set(combined);
        if (unique.size !== combined.length) {
            alert("ê³ ì •/ì»¤ìŠ¤í…€ í™•ì¥ì ê°„ ì¤‘ë³µì´ ìˆìŠµë‹ˆë‹¤");
            return;
        }

        if (combined.length === 0) {
            alert("ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ í™•ì¥ìë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤");
            return;
        }

        const payload = {
            title: "í…ŒìŠ¤íŠ¸",
            content: "ì»¨í…ì¸ ",
            checkedTypes: fixedTypes,
            uploadedExtensions: customList
        };

        try {
            const res = await fetch("/posts", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.message || "ì €ì¥ ì‹¤íŒ¨");
            alert("ê²Œì‹œê¸€ ìƒì„± ì„±ê³µ! ID: " + data.id);
        } catch (e) {
            alert("ì—ëŸ¬ ë°œìƒ: " + e.message);
        }
    }


</script>
</body>
</html>
